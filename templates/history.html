<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Historial de Órdenes</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/history.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/multiple-select/1.5.2/multiple-select.min.css">
</head>
<body>
  <h1>Historial de Órdenes</h1>
  <p><a href="{{ url_for('dashboard') }}">← Volver al Dashboard</a></p>
  <form class="filter" method="get">
    <label>Desde
      <input type="date" name="start_date" value="{{ filters.start_date }}">
    </label>
    <label>Hasta
      <input type="date" name="end_date" value="{{ filters.end_date }}">
    </label>
    <label>Almacén
      <select name="whscode" multiple>
        {% for wh in warehouses %}
        <option value="{{ wh }}" {% if wh in filters.whscode %}selected{% endif %}>{{ wh }}</option>
        {% endfor %}
      </select>
    </label>
    {% if is_admin %}
    <label>Usuario
      <select name="username" multiple>
        {% for u in users_options %}
        <option value="{{ u }}" {% if u in filters.username %}selected{% endif %}>{{ u }}</option>
        {% endfor %}
      </select>
    </label>
    {% endif %}
    <button type="submit">Filtrar</button>
  </form>
  <div class="table-wrapper">
  <table class="history-table">
    <thead>
      <tr>
        <th>Fecha / Hora</th>
        <th>Usuario</th>
        <th>Cliente (CardCode)</th>
        <th>Almacén</th>
        <th>Doc SAP</th>
        <th>Artículo</th>
        <th>Cantidad</th>
      </tr>
    </thead>
    <tbody>
    {% for r in rows %}
      <tr>
        <td>{{ r['timestamp'] }}</td>
        <td>{{ r['username'] }}</td>
        <td>{{ r['cardcode'] }}</td>
        <td>{{ r['whscode'] }}</td>
        <td>{{ r['docnum'] }}</td>
        <td>{{ r['itemcode'] }}</td>
        <td>{{ r['quantity'] }}</td>
      </tr>
    {% endfor %}
    {% if not rows %}
      <tr>
        <td colspan="7">No hay órdenes registradas aún.</td>
      </tr>
    {% endif %}
    </tbody>
  </table>
  </div>
  <form method="get" action="{{ url_for('export_history') }}">
    <input type="hidden" name="start_date" value="{{ filters.start_date }}">
    <input type="hidden" name="end_date" value="{{ filters.end_date }}">
    {% for w in filters.whscode %}
    <input type="hidden" name="whscode" value="{{ w }}">
    {% endfor %}
    {% for u in filters.username %}
    <input type="hidden" name="username" value="{{ u }}">
    {% endfor %}
    <button type="submit">Exportar a Excel</button>
  </form>
  <p><a href="{{ url_for('logout') }}">Cerrar sesión</a></p>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/multiple-select/1.5.2/multiple-select.min.js"></script>
  <script>
    $(function() {
      $('select[multiple]').multipleSelect({
        filter: true,
        placeholder: 'Selecciona...',
        width: 200
      });
    });
  </script>
</body>
</html>